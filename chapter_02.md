# 第2章 リファクタリングの原則

## リファクタリングの定義
- 名詞：外部から見たときの振る舞いを保ちつつ、理解や修正が簡単になるように、ソフトウェアの内部構造を変化させること。
- 動詞：一連のリファクタリングを適用して、外部から見た振る舞いの変更なしに、ソフトウェアを再構築すること。

- リファクタリング期間中に数日間コードが壊れたままになっているなら、それはリファクタリングとは言えない。（p.46）
##  二つの帽子
- 機能追加とリファクタリングを区別する。両者を逐一切り替えて進める。

## リファクタリングを行う理由
- リファクタリングはソフトウェア設計を改善する。
- リファクタリングはソフトウェアを理解しやすくする。
- リファクタリングはバグの発見を助ける。
- リファクタリングはプログラミングを速める。

## いつリファクタリングをすべきか
### 準備のためのリファクタリング　機能追加を容易にするために
    - 既存のコードに機能追加する前は、リファクタリングするのに最適なタイミング。
### 理解のためのリファクタリング　コードをわかりやすくするために
### ゴミ拾いのためのリファクタリング
### 計画されたリファクタリングと、機に応じたリファクタリング
    - ほとんどのリファクタリングは、何か別のことをしている最中に行われる。
    - 変更の要求が来たら、まず変更が容易になるようにし、それから容易になった変更を行う。
### 長期のリファクタリング
    - 巨大な修正を行う場合にも、チームをリファクタリングに専念させるのはお勧めできない。
    - 直近の数週間で問題を徐々に解決していくことにチームで合意するのが有効なやり方。
### コードレビュー時のリファクタリング
    - レビュー時に、アイデアが浮かんだら実際にリファクタリングをしてみるのも有効
    - コードの作者と並んで一対一でコードレビューをしてリファクタリングを行うのがもっともうまくいく。
### 管理者を説得するには
    - 管理者が技術に詳しい場合は、説明はそれほど難しくない。
    - 管理者が重要性を理解できない場合のアドバイスは、「彼らには黙ってリファクタリングする」である。
    - 新たな機能を素早く提供する技能を買われているわけであり、その手段としてリファクタリングが最も近道になる。

### リファクタリングを避けるとき
- どのようにして動いているのか理解しなければならない状況になった時に初めて、リファクタリングの利点が出てくる。単なるAPIと見なせるなら、放置することもできる。
- リファクタリングをするか、最初から書き直すかの判断は難しい。

## リファクタリングの問題点
### 新機能の実装が遅くなる
- リファクタリングの目的は、少ない労力で多くの価値を生み出すべくプログラミングの速度を上げることにある。
- リファクタリングは、コードベースがどれだけ美しいかではなく、純粋に経済的な基準で測られるものである。

### コードの所有権
- 呼び出されるコード側に強い所有権があると、リファクタリングを進めづらい。呼び出す側、呼び出される側の両者を変更する方が都合が良い場合があるためである。他チームのコードについても、そのチームのレビューを受ければ変更できるような運用が好ましい。

### ブランチ
- 機能ごとにブランチを作る方式は、リファクタリングを難しくする。機能ブランチを2、3日程度の短いものに保つようにするのが好ましい。このやり方が継続的インテグレーション（CI）である。
- CIを行うために考慮すべきこともあるが、マージの複雑さを軽減し、何よりリファクタリングと強調できることから、推奨する。CIを完全に実施していない環境でも、なるべくメインブランチへの統合頻度を高くするべきである。

### テスト
- リファクタリングをしたいなら、素早くエラーを見つけるためにも、ほとんどの場合テストコードが必要になる。テストが失敗した時は前回成功した時との差分を見れば良いので、バグの発見は簡単になる。これは、リファクタリングは新たなバグを生むリスクを冒すことだと心配する人に対する答えにもなる。

### レガシーコード
- レガシーコードはたいていの場合複雑で、テストコードも書かれておらず、その上「他の誰か」によって書かれている。この場合、やはりテストを追加していく必要がある。
- だが、テストを書くことを想定して設計されていないので、実際にやるのは非常に厄介である。
- アドバイスとしては、「レガシーコード改善ガイド」のガイダンスに従うこと。かいつまんで言うと、テストを挿入できる接合部となる部分をプログラム中に見つけることで、システムをテストの保護下に置いていくことが書かれている。

### データベース
- 「データベース・リファクタリング」が開発されている。
- 通常のリファクタリングとの違いは、正式に至るまでに複数のリリースに分割するのがベストということ。

## リファクタリングとアーキテクチャ、そしてYagni
- 著者が駆け出しの頃は、ソフトウェア設計及びアーキテクチャは、コードを書き始める前に入念に行うものだった。
- 一方、リファクタリングは全く異なる見方を打ち出している。リファクタリングによって、既存のコードの設計を改善していくことができる。
- リファクタリングがアーキテクチャに与えた最も大きな影響は、要求の変化にしなやかに対応できる、優れた設計のコードベースを作り上げる方法を示したことである。
- 将来の変更に対応するために、ソフトウェアに柔軟性を持たせる仕組みを入れておく方法は、実は変化に対応する速度をかえって「遅く」してしまう。
- リファクタリングは、上記の代わりに、現在わかっている要求のみを解決するソフトウェアを構築する。ソフトウェアを複雑にするような柔軟性の仕組みは、採用の前に有効性を証明しなければならない。後でリファクタリングするのが難しいかどうか見積もってみて、難しいと感じたら、そこで初めて柔軟性の仕組みの導入を考える。
- この設計手法はYagniなどと呼ばれる。Yagniは"You aren't going to need it"（どうせ必要にならない）の頭文字をとったもの。Yagniを採用するからといって、事前のアーキテクチャ検討を蔑ろにするわけではないが、進化的アーキテクチャの原則が広まりつつあり、アーキテクチャに関する決定は繰り返し行うことができる。

## リファクタリングとソフトウェア開発プロセス
- エクストリーム・プログラミング（XP）は、従来と大きく異なった相互補完的なプラクティスを組み合わせることで知られており、要素としてCI、自己テストコード、リファクタリングなどが例として挙げられる。
- XPは最も古くからあるアジャイル開発手法の一つである。アジャイルな考え方は一般に広く受け入れられてきているが、真にアジャイルなやり方を実践するには、チームメンバはリファクタリングの技能を持ち、かつ熱心に取り組む人たちでなければならない。
- 自己テストコードはリファクタリングを支える第一の基盤である。
- また、各メンバのリファクタリング結果を素早く共有するためにも、CIは重要である。自己テストコードはCIの鍵でもある。自己テストコード、CI、リファクタリングという三つのプラクティスには強い相乗効果がある。
- Yagniという設計手法は、この三つのプラクティスの実践があって初めて可能になる上、リファクタリングとYagniは相互に補完しあう。
- こうしたコアのプラクティスがきちんと行えていれば、アジャイル開発手法の他の要素も活用できる基盤ができていることになる。確固とした技術基盤を持つことで、アイデアを製品に投入するまで時間の削減や、顧客に対してより良いサービスが提供できる。

## リファクタリングとパフォーマンス
- ソフトウェアを理解しやすくするための変更は、しばしばプログラムの実行速度を落とすことがあり、これについては深刻に受け止めるべきである。リファクタリングは、実行速度を遅くすることもある一方で、よりパフォーマンスチューニングしやすい形にする。
- 速いソフトウェアを作る一般的な方法は三つある。
- 最も厳しい要求を実現するのが、実行スケジューリングを行うやり方。
- 第二の方法は、パフォーマンスを常に意識するやり方。これはあまりうまくいかない。大抵プログラムをわかりにくくし、開発効率が悪くなるため。
- パフォーマンスで興味深いのは、プログラムを解析してみると、ほとんどの時間がごくわずかの処理で集中的に消費されているという事実である。システムが行なっていることを十分に分かっているつもりでも、推測はやめてまず実際に計測を行い、それによって学ぶことが重要である。コード全体にわたって均等に最適化を行なっても、90％の活動は無駄になる。
- 第三の方法は、パフォーマンスチューニングに前述の90％の法則を使うことである。このやり方では、まずパフォーマンスを気にせずに、プログラムを綺麗に整理された形で作る。そして、チューニングの段階に来て、初めてパフォーマンスを考慮する。その際、一定の手順に従って最適化を行う。
- 手順：時間とメモリをどこで消費しているかを計測するためのプロファイラを実行。ホットスポットが検出されたら、その部分についてのみ第二の方法で述べた最適化を行う。注意すべきことは、リファクタリング同様、変更を小さなステップ（コンパイル、テスト、プロファイラによる実行）の積み重ねで行うこと。
- この最適化方式（第三の方法）を採用する場合、プログラムがリファクタリングされていると、二つの点で有利である。第一に、パフォーマンスチューニングに十分な時間をかけられること、第二に、きれいに整理されているため、パフォーマンス解析の際、より細かな単位に集中できること。

## リファクタリングの起源
- 古くから、優れたプログラマはコードを整理する作業をしてきた。リファクタリングは、このコードを整理するという考えをさらに大きく発展させたもの。
- リファクタリングの重要性に最初に気づいたのは、Ward CunninghamとKent Beck。彼らは、Smalltalkの動的な開発環境に、最も合致した開発プロセスを探求していた。現在、この開発プロセスはエクストリーム・プログラミングと呼ばれる。彼らのアイデアは、Smalltalkのコミュニティに受け入れらていった。
- その後、Bill Opdykeが初期の最もまとまったリファクタリングの研究成果を博士論文として出した。そして、著者がKentと一緒のプロジェクトに参画し、リファクタリングの重要性を認識し、本書の初版を執筆した。

## 自動化されたリファクタリング
- この10年間でリファクタリングに起きた最も大きな変化は、リファクタリングツールが利用できるようになったこと。
- 適切にリファクタリングを行うには、ツールはプログラムのテキストではなく、構文木を操作すべき。
- 多くのリファクタリングは、静的型付け言語に行う方が、ずっと安全に行える。
- 構文木をプログラムの解析とリファクタリングの両方に使う技術は非常に強力なため、シンプルなテキストエディタに対してIDEが持つ大きな利点となる。

## さらに興味のある方へ
- リファクタリングの学習書としては、Bill Wakeの『Refactoring Workbook』がおすすめ。
- Josh Kerievskyの『パターン志向リファクタリング入門』は、GOFのパターン本の一部にリファクタリングを適用する方法を示している。
- 特定分野でのリファクタリング本としては、Scott AmblerとPramod Sadalageの『データベース・リファクタリング』や、Elliotte Rusty Haroldの『Refactoring HTML』が特に有益。
- 『レガシーコード改善ガイド』は、テストカバレージが極めて低いレガシーなコードベースを、どのようにリファクタリングしていけば良いかについて取り上げた最初の本。
- プログラミング言語に特化したリファクタリングの本としては、Jay FieldsとShane Harveyの『リファクタリング：Rubyエディション』がある。
- より最新の情報は、本書のWeb版やリファクタリングのメインサイトrefactoring.comを参照のこと。
