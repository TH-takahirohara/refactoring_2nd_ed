# 第11章 APIのリファクタリング


- すぐれた API は、データを更新する関数とデータを参照するだけの関数を明確に分離する。
    - 上記が混在しているのを見つけたら、「問い合わせと更新の分離」を適用して分離する。
    - 値の違いだけで変化する関数のバリエーションは、「パラメータによる関数の統合」を適用して統合する。
    - 振る舞いを切り替えるだけのパラメータは「フラグパラメータの削除」を適用して削除する。
- 関数間でデータ構造が受け渡されるとき、必要以上に細切れにされることがよくある。その場合、「オブジェクトそのものの受け渡し」を適用して、まとめて渡すようにする。
    - 何をパラメータとして渡すか、何を関数内で取得するかの判断の過程では、「問い合わせによるパラメータの置き換え」と「パラメータによる問い合わせの置き換え」の間を行ったり来たりすることになる。
- オブジェクトは可能な限り不変にすべきなので、「setterの削除」を使えるところがあればすぐに適用する。
- 新たに生成されたオブジェクトを呼び出し元が必要とするときは、コンストラクタよりも柔軟な仕組みがほしくなることがよくある。その場合は「ファクトリ関数によるコンストラクタの置き換え」を適用する。
- 大量のデータを受け渡すような、かなり複雑な関数を分解するときは、「コマンドによる関数の置き換え」を適用し、関数をオブジェクトに変換する。
- 後に、その関数が簡単になってコマンドオブジェクトにしておく必要がなくなったときは、「関数によるコマンドの置き換え」を適用して関数に戻す。

## 問い合わせと更新の分離

### 動機
- 観察可能な副作用がない関数は、悩む必要を大幅に減らす。
    - 観察可能な副作用があると、問い合わせごとに異なる結果が返ることがある。
- 値を返すにもかかわらず副作用を持つメソッドがあったら、更新を行う箇所から問い合わせを分離すべき。

### 手順
- 関数をコピーして、問い合わせ用の名前をつける。
- 新しい問い合わせ関数から副作用をすべて除去する。
- 静的検査を実行する。
- 元の関数の呼び出しを調べる。戻り値を使っている場合は、その呼び出しを問い合わせ関 数の呼び出しに置き換え、元の関数の呼び出しをその後ろ訳注1に挿入する。変更のたびにテ ストする。
- 元の関数から戻り値を削除する。
- テストする。
